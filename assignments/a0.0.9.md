### [Assignment9]

## request lifecycle and *route level* extensions 

Make ***route level*** extension to handle invalid data passed to `/login` route.<br/>
Previous assignments registered a function as ***application level*** extension to handle invalid data passed `/login`. 

**See** [lib/index.js](../lib/index.js) for all functions registered as ***application level*** extensions.
```
  webTls.ext('onPreResponse', function) 
```

If not familiar with hapi's request lifecycle or do not know the difference between ***route level*** 
extensions versus ***application level*** extensions, [read this first](../guides/lifecycle.md). 

Server level extensions are really powerful.  However, using them to check route specific errors is wasteful. 
Currently, our hapi application has a problem. Every request received by the application checks for `/login` route validation errors. 
It would be best to check for these validation errors only when requests to the `/login` route are made.  
To do this, we change the error checking from an ***application level*** extension to a ***request level*** extension.
Conveniently, hapi allows us to make ***request level*** extensions in the route configuration object.<br/>
See: [route configuration object](https://hapijs.com/api#route-configuration), [route options](https://hapijs.com/api#route-options), and 
[look here](../lib/api/user.js) for route level extension configuration example. The ***route level extension*** configuration looks like below:<br/>
```
config: {
    ...
    path: '/login',
    ext: {
        onPreResponse: { method: internals.handleJoiValidationFailure }
     },
     ...
     ...
}
```

In this assignment, we make a ***request level*** lifecycle extension on the `/login` route.
Custom error messages specific to the `/login` route are returned.  Previously, we used an ***application level*** lifecycle extension.
After this lesson, our application will have two levels of lifecycle extensions: 
* **application level extensions**<br/> 
  Apply to all points of the application (server wide). <br/>
  For example:
  - enforces tls on all routes
  - redirects /home if insufficient user scope 
  - handles bad route attempts (route does not exist) 
* **route level extensions**<br/>
  Apply to a specific point or route in the application.<br/>
  For example:
  - handle invalid data sent to /login

Note, there is a third type of lifecycle extension in the hapi framework:
***plugin level*** extensions. Plugin level extensions apply to all routes within a plugin.
Our project does not use ***plugin level*** extensions yet.

Read through below resources.  hapi's lifecycle and it's plugin architecture are the backbone of the hapi framework 
(source @AdriVanHoudt - See his nodeconf talk proposal [here](https://gist.github.com/AdriVanHoudt/562f537ba48301bac76fb3bc42def5b3)).

### For more details read:
- Docs:
  * [university write up on request lifecycle](../guides/lifecycle.md)
  * [hapi docs - request lifecycle](https://hapijs.com/api#request-lifecycle)
  * [server.ext(events)](https://hapijs.com/api#serverextevents) - Register an array of event objects as ***application level*** extensions. 
  * [server.ext(event, method, [options])](https://hapijs.com/api#serverextevent-method-options) - Register a single extension event as a ***application level*** extension.
  * [route options](https://hapijs.com/api#route-options)
    - Describes how to add ***route level*** extensions.<br/>
      Pay attention to documentation about 'ext' configs option.
    - ```
        config: {
          ext: {
                onPreResponse: { method: function }
          ...
          ...
        }
      ```
  * ***plugin level*** extensions See @mtharrison [plugin level and route level extensions](https://stackoverflow.com/questions/37424079/how-to-apply-a-hapi-js-plugin-to-specific-routes) to the lifecycle.
  * [route prerequisites](https://hapijs.com/api#route-prerequisites)
    - Not used in this lesson but shows how to configure a route with the `pre` option.<br/>
      Useful to load data from a db for the request.
- @AdriVanHoudt on request lifecycle and plugins: [hapi cycling through life](https://gist.github.com/AdriVanHoudt/562f537ba48301bac76fb3bc42def5b3)<br/>
  Has a nice graphic illustrating the hapi request lifecycle.
- What is a hook?
  A hook is functionality provided by software for users of that software to have their own code called under certain circumstances. 
  That code can augment or replace the current code. 
  (source: [SO](https://stackoverflow.com/questions/467557/what-is-meant-by-the-term-hook-in-programming))
